## Tabla de Consultas SPL para Hunt for Kerberoasting
| **Consulta**                                                                 | **Propósito**                                                                 |
|------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4769 (TicketEncryptionType=0x1 OR TicketEncryptionType=0x3 OR TicketEncryptionType=0x17 OR TicketEncryptionType=0x18) \| eval Source=if(IpAddress=\"::1\", Computer, IpAddress) \| table _time, host, Source, TargetUserName, ServiceName, TicketEncryptionType \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", TargetUserName AS \"Target Username\", ServiceName AS \"Service Name\", TicketEncryptionType AS \"Ticket Encryption\" \| convert ctime(Time)" | Detecta solicitudes de tickets de servicio con cifrado débil, indicativo de Kerberoasting. |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4769 ServiceName != krbtgt \| regex ServiceName != \"\\$$\" \| transaction IpAddress maxpause=5m maxevents=-1 \| eval services=mvcount(ServiceName) \| where services > 1 \| eval Source=if(IpAddress=\"::1\", Computer, IpAddress) \| table _time, host, Source, TargetUserName, services, ServiceName, TicketEncryptionType \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", TargetUserName AS \"Target Username\", services AS \"Number of Services\", ServiceName AS \"Service Name\", TicketEncryptionType AS \"Ticket Encryption\" \| convert ctime(Time)" | Detecta solicitudes excesivas de tickets de servicio desde una fuente. |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4769 IpPort > 0 (IpPort < 1024 OR (NOT (IpAddress=10.0.0.0/8 OR IpAddress=172.16.0.0/12 OR IpAddress=192.168.0.0/16 OR IpAddress=127.0.0.1 OR IpAddress=::1))) \| table _time, host, IpAddress, IpPort, TargetUserName, ServiceName, TicketEncryptionType \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", IpAddress AS Source, IpPort AS \"Source Port\", TargetUserName AS \"Target Username\", ServiceName AS \"Service Name\", TicketEncryptionType AS \"Ticket Encryption\" \| convert ctime(Time)" | Detecta solicitudes de tickets de servicio desde direcciones externas o puertos inusuales. |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4769 ServiceName=Honeypot01 \| eval Source=if(IpAddress=\"::1\", Computer, IpAddress) \| table _time, host, Source, TargetUserName, ServiceName, TicketEncryptionType \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", TargetUserName AS \"Target Username\", ServiceName AS \"Service Name\", TicketEncryptionType AS \"Ticket Encryption\" \| convert ctime(Time)" | Detecta solicitudes de tickets hacia una cuenta honeypot, indicativo de Kerberoasting. |
| "index=\"ad_hunting\" source=\"WinEventLog:Microsoft-Windows-PowerShell/Operational\" (EventCode=4103 OR EventCode=4104) \| transaction Computer maxpause=15m maxevents=-1 \| eval raw=_raw \| search [\| inputlookup service_accounts.csv \| eval raw=\"*\" . account . \"*\" \| fields raw] \| where eventcount > 2 \| table _time, Computer, eventcount \| sort - _time \| rename _time AS \"Time\", Computer AS \"Host\", eventcount AS \"Number of Events\" \| convert ctime(Time)" | Detecta manipulación de cuentas de servicio vía PowerShell (sin resultados en este lab). |
