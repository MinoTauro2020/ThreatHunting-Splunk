## Tabla de Consultas SPL para Hunt for Brute Force Attacks inside Active Directory
| **Consulta**                                                                 | **Propósito**                                                                 |
|------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| "index=\"ad_hunting\" sourcetype=XmlWinEventLog EventCode=4768 Status=0x6 \| transaction IpAddress maxpause=5m maxevents=-1 \| where eventcount > 5 \| eval Source=if(IpAddress=\"::1\", Computer, IpAddress) \| eval accounts=mvcount(TargetUserName) \| where accounts > 2 \| table _time, host, Source, TargetUserName, accounts, eventcount \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", Source AS \"Source Computer\", TargetUserName AS \"Target Username\", accounts AS \"Number of Accounts\", eventcount AS \"Total Attempts\" \| convert ctime(Time)" | Detecta intentos de inicio de sesión Kerberos con cuentas inexistentes (Status=0x6). |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4776 Status=0xC0000064 \| transaction Workstation maxpause=5m maxevents=-1 \| where eventcount > 5 \| eval accounts=mvcount(TargetUserName) \| where accounts > 2 \| table _time, host, Workstation, TargetUserName, accounts, eventcount \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", Workstation AS \"Source\", TargetUserName AS \"Target Username\", accounts AS \"Number of Accounts\", eventcount AS \"Total Attempts\" \| convert ctime(Time)" | Detecta intentos de inicio de sesión NTLM con cuentas inexistentes (Status=0xC0000064). |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4771 Status=0x18 \| transaction IpAddress maxpause=5m maxevents=-1 \| where eventcount > 5 \| eval Source=if(IpAddress=\"::1\", Computer, IpAddress) \| eval accounts=mvcount(TargetUserName) \| table _time, host, Source, TargetUserName, accounts, eventcount \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", Source AS \"Source Computer\", TargetUserName AS \"Target Username\", accounts AS \"Number of Accounts\", eventcount AS \"Total Attempts\" \| convert ctime(Time)" | Detecta intentos de fuerza bruta o password spraying Kerberos con contraseñas incorrectas (Status=0x18). |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4776 Status=0xC000006A \| transaction Workstation maxpause=5m maxevents=-1 \| where eventcount > 5 \| eval accounts=mvcount(TargetUserName) \| where accounts > 2 \| table _time, host, Workstation, TargetUserName, accounts, eventcount \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", Workstation AS \"Source\", TargetUserName AS \"Target Username\", accounts AS \"Number of Accounts\", eventcount AS \"Total Attempts\" \| convert ctime(Time)" | Detecta intentos de fuerza bruta o password spraying NTLM con contraseñas incorrectas (Status=0xC000006A). |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security ((EventCode=4776 Status=0xC000006A) OR (EventCode=4771 Status=0x18)) \| eval src=if(src=\"::1\", Computer, src) \| transaction TargetUserName maxpause=5m maxevents=-1 \| eval sources=mvcount(src) \| where eventcount > 5 AND sources > 1 \| table _time, host, TargetUserName, sources, src, eventcount \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", TargetUserName AS \"Target Username\", sources AS \"Number of Sources\", src AS \"Source\", eventcount AS \"Total Attempts\" \| convert ctime(Time)" | Detecta intentos de fuerza bruta hacia una cuenta desde múltiples fuentes (Kerberos y NTLM). |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4740 \| transaction TargetDomainName maxpause=1h maxevents=-1 \| eval accounts=mvcount(TargetUserName) \| where accounts > 1 \| table _time, host, TargetDomainName, TargetUserName, accounts \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", TargetDomainName AS \"Source\", TargetUserName AS \"Target Username\", accounts AS \"Number of Accounts\" \| convert ctime(Time)" | Detecta múltiples bloqueos de cuentas desde una misma fuente. |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4768 Status=0x12 \| transaction IpAddress maxpause=5m maxevents=-1 \| where eventcount > 5 \| eval Source=if(IpAddress=\"::1\", Computer, IpAddress) \| eval accounts=mvcount(TargetUserName) \| where accounts > 2 \| table _time, host, Source, TargetUserName, accounts, eventcount \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", TargetUserName AS \"Target Username\", accounts AS \"Number of Accounts\", eventcount AS \"Total Attempts\" \| convert ctime(Time)" | Detecta intentos repetitivos de inicio de sesión Kerberos hacia cuentas deshabilitadas (Status=0x12). |

