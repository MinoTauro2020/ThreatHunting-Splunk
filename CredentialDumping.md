## Tabla de Consultas SPL para Hunt for Credential Dumping
| **Consulta**                                                                 | **Propósito**                                                                 |
|------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| "index=\"ad_hunting\" source=\"xmlwineventlog:microsoft-windows-sysmon/operational\" EventCode=8 OR EventCode=10 NOT GrantedAccess=0x1400 NOT GrantedAccess=0x1000 NOT GrantedAccess=0x100000 \| where (TargetImage LIKE \"%lsass.exe\") \| search NOT SourceImage=\"C:\\Windows\\system32\\wininit.exe\" NOT SourceImage=\"C:\\Windows\\system32\\csrss.exe\" \| transaction host, SourceImage, SourceProcessId maxspan=15m \| table _time, host, SourceImage, SourceProcessId, GrantedAccess \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", SourceImage AS \"Process\", SourceProcessId AS \"Process ID\", GrantedAccess AS \"Access Mask\" \| convert ctime(Time)" | Detecta posible volcado de memoria de lsass.exe mediante eventos Sysmon. |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=4656 NOT AccessMask=0x1400 NOT AccessMask=0x1000 NOT AccessMask=0x100000 \| where (ObjectName LIKE \"%lsass.exe\") \| search NOT ProcessName=\"C:\\Windows\\system32\\lsass.exe\" \| transaction host, ProcessName, ProcessId maxspan=15m \| table _time, host, ProcessName, ProcessId, AccessMask \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", ProcessName AS \"Process\", ProcessId AS \"Process ID\", AccessMask AS \"Access Mask\" \| convert ctime(Time)" | Detecta posible volcado de memoria de lsass.exe mediante eventos de Windows. |
| "index=\"ad_hunting\" source=\"xmlwineventlog:microsoft-windows-sysmon/operational\" EventCode=11 TargetFilename=*dmp \| table _time, host, Image, ProcessId, TargetFilename \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", Image AS \"Process\", ProcessId AS \"Process ID\", TargetFilename AS \"Filename\" \| convert ctime(Time)" | Detecta la creación de archivos .dmp, posibles volcados de memoria. |
| "index=\"ad_hunting\" source=\"xmlwineventlog:microsoft-windows-sysmon/operational\" EventCode=6 Signed=false \| table _time, host, ImageLoaded, SHA1, SignatureStatus \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", ImageLoaded AS \"Image Loaded\", SignatureStatus AS \"Signature Status\" \| convert ctime(Time)" | Detecta instalación de controladores sin firma, posible actividad de herramientas como Mimikatz. |
| "index=\"ad_hunting\" source=XmlWinEventLog:Security EventCode=5145 RelativeTargetName=\"*test.local\\Policies\\{12345}*\" \| transaction IpAddress, SubjectUserSid maxspan=5m maxevents=-1 \| table _time, host, IpAddress, SubjectUserName, SubjectUserSid, SubjectLogonId \| sort - _time \| rename _time AS \"Time\", host AS \"Host\", IpAddress AS \"Source IP\", SubjectUserName AS \"Username\", SubjectUserSid AS \"Account SID\", SubjectLogonId AS \"Logon ID\" \| convert ctime(Time)" | Detecta accesos a un honeypot en SYSVOL, indicativo de búsqueda de credenciales. |
| "index=\"ad_hunting\" source=\"xmlwineventlog:security\" EventCode=4688 NewProcessName=\"*vssadmin.exe\"" | Detecta uso de vssadmin.exe, posible intento de volcar NTDS.dit mediante Volume Shadow Copy. |
| "index=\"ad_hunting\" source=\"xmlwineventlog:security\" EventCode=4662 Properties=\"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\" OR Properties=\"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\" OR Properties=\"*1131f6ab-9c07-11d1-f79f-00c04fc2dcd2*\" Caller_User_Name=Administrator" | Detecta abuso de Directory Replication Service para volcar credenciales (DCSync). |
| "index=\"ad_hunting\" EventCode=4624 0x107d67" | Correlaciona el Logon ID de un evento 4662 para identificar la fuente del intento de DCSync. |
