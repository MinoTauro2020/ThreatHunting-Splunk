## Tabla de Consultas SPL para Investigar Actividad Sospechosa de `w3wp.exe` en Servidor IIS

| **Consulta**                                                                 | **Propósito**                                                                 |
|------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| `index=* sourcetype="WinEventLog:Security" EventCode=4688 NewProcessName="*\w3wp.exe" \| table _time, host, AccountName, NewProcessName, ParentProcessName, ProcessId` | Identifica ejecuciones de `w3wp.exe`, mostrando usuario, proceso padre, y host para detectar anomalías. |
| `index=* sourcetype="WinEventLog:Security" EventCode=4688 ParentProcessName="*\w3wp.exe" NewProcessName IN ("*\cmd.exe", "*\powershell.exe", "*\msbuild.exe", "*\csc.exe") \| table _time, host, AccountName, NewProcessName, ParentProcessName, ProcessId` | Detecta procesos sospechosos (como `cmd.exe` o `powershell.exe`) iniciados por `w3wp.exe`, un indicador de posible explotación. |
| `index=* sourcetype="WinEventLog:Security" EventCode=4688 NewProcessName="*\w3wp.exe" \| stats count by host, AccountName, NewProcessName \| where AccountName != "IIS APPPOOL\*" AND AccountName != "NETWORK SERVICE"` | Identifica cuentas no esperadas ejecutando `w3wp.exe`, como cuentas de usuario o administrativas, que podrían indicar abuso. |
| `index=* sourcetype="iis" cs_uri_stem IN ("*.aspx", "*.asp") (cs_method="POST" OR cs_method="GET") \| table _time, c_ip, cs_method, cs_uri_stem, cs_user_agent, sc_status, s_port \| where sc_status=200` | Busca solicitudes HTTP exitosas a archivos `.aspx` o `.asp`, que podrían ser web shells (por ejemplo, `human2.aspx`). |
| `index=* sourcetype="iis" cs_uri_stem IN ("*.aspx", "*.asp") \| stats count by c_ip, cs_uri_stem, cs_method \| where count > 5` | Detecta accesos repetidos a archivos `.aspx` o `.asp` desde una misma IP, un patrón típico de interacción con web shells. |
| `index=* sourcetype="iis" cs_uri_stem IN ("*human2.aspx", "*cmd.aspx", "*/aspnet_client/*") \| table _time, c_ip, cs_uri_stem, sc_status` | Busca accesos a archivos específicos mencionados en el artículo de EcuCERT (por ejemplo, `human2.aspx`) o en directorios sospechosos. |
| `index=* sourcetype="WinEventLog:Security" EventCode=4698 \| table _time, host, TaskName, TaskContent \| search TaskContent IN ("*powershell*", "*cmd*", "*.aspx")` | Identifica tareas programadas creadas que puedan invocar scripts o archivos web, un método común de persistencia. |
| `index=* sourcetype="WinEventLog:System" EventCode=7045 ServiceName="*" \| table _time, host, ServiceName, ImagePath \| search ImagePath IN ("*powershell*", "*cmd*", "*.aspx")` | Detecta servicios nuevos que ejecuten scripts o archivos `.aspx`, un indicador de persistencia maliciosa. |
| `index=* sourcetype="stream:tcp" src_ip=<IP_DEL_SERVIDOR_IIS> dest_port!=80 dest_port!=443 \| table _time, src_ip, dest_ip, dest_port` | Busca conexiones de red salientes desde el servidor IIS a puertos no estándares, que podrían indicar comunicación con un servidor C2. Nota: Sustituye `<IP_DEL_SERVIDOR_IIS>` con la IP real del servidor. |
| `index=* sourcetype="WinEventLog:Security" EventCode=19 \| table _time, host, UpdateTitle` | Verifica actualizaciones recientes aplicadas en el servidor para correlacionar con parches de vulnerabilidades de IIS. |

## Tabla de Consultas SPL para Monitoreo y Respuesta en Tiempo Real

| **Consulta**                                                                 | **Propósito**                                                                 |
|------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
| `index=* sourcetype="WinEventLog:Security" NewProcessName="*\w3wp.exe" \| live_tail` | Monitorea en tiempo real la actividad de `w3wp.exe` para detectar nuevos eventos sospechosos durante la investigación. |
| `index=* sourcetype="iis" cs_uri_stem IN ("*.aspx", "*.asp") cs_method="POST" sc_status=200 \| stats count by c_ip, cs_uri_stem \| where count > 5` | Configura una alerta para detectar accesos frecuentes a archivos `.aspx` o `.asp`, un indicador de interacción con web shells. |
| `index=* sourcetype="WinEventLog:Security" EventCode=4688 NewProcessName="*\w3wp.exe" \| outputcsv w3wp_investigation.csv` | Exporta eventos relacionados con `w3wp.exe` para análisis forense o documentación. |
| `index=* sourcetype="WinEventLog:Security" EventCode=4688 ParentProcessName="*\w3wp.exe" NewProcessName IN ("*\cmd.exe", "*\powershell.exe") \| stats count by host, NewProcessName` | Configura una alerta para detectar procesos sospechosos iniciados por `w3wp.exe`, como `cmd.exe` o `powershell.exe`. |
